import { Meta } from '@storybook/blocks';

<Meta title="Documentation/Core/PageRenderer" />

# PageRenderer

Transform JSON configurations into complete React pages with automatic validation, type-safe rendering, and adapter support.

---

## üìã Overview

PageRenderer is the core component that powers JSON-driven UIs. It takes a JSON configuration, validates it against schemas, and renders a complete React page using registered templates and components.

**Key Features:**
- ‚úÖ JSON-to-React transformation
- ‚úÖ Schema validation with Zod
- ‚úÖ Automatic adapter resolution
- ‚úÖ Error boundaries and fallbacks
- ‚úÖ Inline validation display
- ‚úÖ Provider switching support

---

## üéØ When to Use

### ‚úÖ Use PageRenderer When:
- Building dynamic, data-driven UIs
- Content comes from CMS or backend
- Need non-technical users to configure pages
- Building multi-tenant applications with different layouts
- Rapid prototyping without code changes

### ‚ùå Don't Use PageRenderer When:
- Static, never-changing layouts
- Complex interactive logic required
- SEO-critical content (consider SSR)
- Performance is critical (direct JSX is faster)
- Simple one-off pages

---

## üìä Props Reference

### PageRendererProps Interface

```typescript
interface PageRendererProps {
  /** Page configuration (JSON or validated object) */
  config: PageConfig | string;
  
  /** Render options */
  options?: RenderOptions;
  
  /** Loading component */
  loading?: React.ReactNode;
  
  /** Error component */
  errorComponent?: React.ComponentType<{ error: Error; errors?: RenderError[] }>;
  
  /** Callback when rendering completes */
  onRenderComplete?: (result: RenderResult) => void;
  
  /** Callback when adapter warnings occur */
  onAdapterWarning?: (warning: AdapterWarning) => void;
  
  /** Show inline warnings in UI (default: false) */
  showInlineWarnings?: boolean;
}

interface PageConfig {
  /** Page metadata */
  meta?: PageMetadata;
  
  /** Template key from TemplateRegistry */
  template: string;
  
  /** Slot content for the template */
  slots: Record<string, JsonNode | JsonNode[]>;
  
  /** Global behaviors for the page */
  behaviors?: Record<string, string>;
  
  /** Data sources configuration */
  dataSources?: DataSource[];
}

interface JsonNode {
  /** Component type from ComponentRegistry */
  type: string;
  
  /** Component props */
  props?: Record<string, any>;
  
  /** Children nodes or slots */
  children?: JsonNode[] | Record<string, JsonNode | JsonNode[]>;
  
  /** Event handlers mapping to behaviors */
  on?: Record<string, any>;
  
  /** Optional key for React reconciliation */
  key?: string;
}
```

### Required Props

| Prop | Type | Description |
|------|------|-------------|
| `config` | `PageConfig \| string` | JSON config or string |

### Optional Props

| Prop | Type | Default | Description |
|------|------|---------|-------------|
| `options` | `RenderOptions` | `{}` | Render options |
| `loading` | `React.ReactNode` | Spinner | Loading component |
| `errorComponent` | Component | DefaultError | Error component |
| `onRenderComplete` | Function | - | Render callback |
| `onAdapterWarning` | Function | - | Warning callback |
| `showInlineWarnings` | `boolean` | `false` | Show warnings in UI |

---

## üîÑ Rendering Flow

```
JSON Config
    ‚Üì
Schema Validation (validatePageConfig)
    ‚Üì
Template Resolution
    ‚Üì
Component Rendering
    ‚Üì
Adapter Resolution (MUI/ShadCN)
    ‚Üì
React Tree
```

---

## üí° Usage Examples

### Basic Page Rendering

```tsx
import { PageRenderer } from '@sakhlaqi/ui/renderer';

const pageConfig = {
  template: 'DashboardLayout',
  slots: {
    header: {
      type: 'HeaderComposite',
      props: { title: 'Dashboard' }
    },
    content: {
      type: 'Stack',
      props: { spacing: 3 },
      children: [
        { type: 'Card', props: { title: 'Welcome' } }
      ]
    }
  }
};

function MyPage() {
  return <PageRenderer config={pageConfig} />;
}
```

### With Validation

```tsx
import { PageRenderer } from '@sakhlaqi/ui/renderer';
import { validatePageConfig } from '@sakhlaqi/ui/schema';

function ValidatedPage({ jsonConfig }: { jsonConfig: any }) {
  const validation = validatePageConfig(jsonConfig);
  
  if (!validation.success) {
    return (
      <div className="error">
        <h2>‚ùå Invalid Configuration</h2>
        <ul>
          {validation.errors.map((err, i) => (
            <li key={i}>{err.message}</li>
          ))}
        </ul>
      </div>
    );
  }
  
  return <PageRenderer config={validation.data} />;
}
```

### With Loading State

```tsx
import { PageRenderer } from '@sakhlaqi/ui/renderer';

function LoadingPage({ config, isLoading }) {
  if (isLoading) {
    return (
      <PageRenderer 
        config={config}
        loading={<div>Loading your page...</div>}
      />
    );
  }
  
  return <PageRenderer config={config} />;
}
```

### Custom Error Handling

```tsx
import { PageRenderer } from '@sakhlaqi/ui/renderer';

function CustomErrorComponent({ error, errors }) {
  return (
    <div className="my-error-ui">
      <h1>Oops! Something went wrong</h1>
      <p>{error.message}</p>
      <button onClick={() => window.location.reload()}>
        Reload
      </button>
    </div>
  );
}

function PageWithErrorHandling({ config }) {
  return (
    <PageRenderer 
      config={config}
      errorComponent={CustomErrorComponent}
    />
  );
}
```

### With Callbacks

```tsx
import { PageRenderer } from '@sakhlaqi/ui/renderer';

function TrackedPage({ config }) {
  const handleRenderComplete = (result) => {
    console.log('Page rendered:', result);
    // Analytics tracking
    analytics.track('page_rendered', {
      template: config.template,
      components: result.stats.componentCount,
    });
  };
  
  const handleAdapterWarning = (warning) => {
    console.warn('Adapter warning:', warning);
    // Log to monitoring service
    logger.warn('adapter_fallback', warning);
  };
  
  return (
    <PageRenderer 
      config={config}
      onRenderComplete={handleRenderComplete}
      onAdapterWarning={handleAdapterWarning}
      showInlineWarnings={true}
    />
  );
}
```

### Fetching Config from API

```tsx
import { PageRenderer } from '@sakhlaqi/ui/renderer';
import { validatePageConfig } from '@sakhlaqi/ui/schema';
import { useState, useEffect } from 'react';

function DynamicPage({ pageId }) {
  const [config, setConfig] = useState(null);
  const [error, setError] = useState(null);
  
  useEffect(() => {
    fetch(`/api/pages/${pageId}`)
      .then(res => res.json())
      .then(data => {
        const validation = validatePageConfig(data);
        if (validation.success) {
          setConfig(validation.data);
        } else {
          setError(new Error('Invalid config: ' + validation.errors[0].message));
        }
      })
      .catch(setError);
  }, [pageId]);
  
  if (error) return <div>Error: {error.message}</div>;
  if (!config) return <div>Loading...</div>;
  
  return <PageRenderer config={config} />;
}
```

---

## üìù JSON Configuration Guide

### Minimal Configuration

```json
{
  "template": "DashboardLayout",
  "slots": {
    "content": {
      "type": "Text",
      "props": { "children": "Hello World" }
    }
  }
}
```

### Complete Configuration

```json
{
  "meta": {
    "title": "Dashboard",
    "description": "Main dashboard page",
    "version": "1.0.0"
  },
  "template": "DashboardLayout",
  "slots": {
    "header": {
      "type": "HeaderComposite",
      "props": {
        "title": "Dashboard",
        "subtitle": "Welcome back"
      }
    },
    "sidebar": {
      "type": "Stack",
      "props": { "spacing": 2 },
      "children": [
        {
          "type": "Button",
          "props": { "children": "Home", "fullWidth": true },
          "on": { "click": "navigateHome" }
        },
        {
          "type": "Button",
          "props": { "children": "Settings", "fullWidth": true },
          "on": { "click": "navigateSettings" }
        }
      ]
    },
    "content": {
      "type": "Grid",
      "props": { "container": true, "spacing": 3 },
      "children": [
        {
          "type": "Card",
          "props": { 
            "title": "Total Users",
            "value": "1,234"
          }
        },
        {
          "type": "Card",
          "props": { 
            "title": "Revenue",
            "value": "$56,789"
          }
        }
      ]
    }
  },
  "behaviors": {
    "navigateHome": "navigation/goHome",
    "navigateSettings": "navigation/goSettings"
  }
}
```

---

## üîç Schema Validation

### validatePageConfig Function

```typescript
import { validatePageConfig } from '@sakhlaqi/ui/schema';

const result = validatePageConfig(config);

if (result.success) {
  // ‚úÖ Valid config
  const validConfig = result.data;
  return <PageRenderer config={validConfig} />;
} else {
  // ‚ùå Validation errors
  console.error(result.errors);
  result.errors.forEach(err => {
    console.log(err.path.join('.'));  // Path to error
    console.log(err.message);          // Error message
  });
}
```

### Common Validation Errors

**Unknown Component:**
```json
{
  "type": "InvalidComponent"  // ‚ùå Not in ComponentRegistry
}
```
Error: `Component type "InvalidComponent" not found in ComponentRegistry`

**Unknown Template:**
```json
{
  "template": "InvalidTemplate"  // ‚ùå Not in TemplateRegistry
}
```
Error: `Template type "InvalidTemplate" not found in TemplateRegistry`

**Missing Required Fields:**
```json
{
  "template": "DashboardLayout"
  // ‚ùå Missing slots
}
```
Error: `Required property 'slots' is missing`

**Invalid Props:**
```json
{
  "type": "Button",
  "props": {
    "color": "invalid-color"  // ‚ùå Not a valid color
  }
}
```
Error: Depends on component's prop validation

---

## üîå Template System

### Available Templates

| Template | Description | Required Slots |
|----------|-------------|----------------|
| `DashboardLayout` | Header + Sidebar + Content | header, sidebar, content |
| `TwoColumnLayout` | Left + Right columns | left, right |
| `CenteredLayout` | Centered content | content |
| `BlankLayout` | No structure | content |

See [Templates Documentation](?path=/docs/templates-overview) for complete reference.

### Custom Templates

```typescript
import { registerTemplate } from '@sakhlaqi/ui/registry';

registerTemplate('MyTemplate', {
  slots: ['header', 'content', 'footer'],
  render: (slots) => (
    <div className="my-template">
      <header>{slots.header}</header>
      <main>{slots.content}</main>
      <footer>{slots.footer}</footer>
    </div>
  ),
});
```

---

## üì¶ Component Registry

### Built-in Components

All adapter components are available:
- **Actions**: Button, IconButton
- **Inputs**: Input, Select, Checkbox, Radio
- **Display**: Card, Badge, Chip, Avatar
- **Layout**: Stack, Grid, Flex, Box
- **Feedback**: Alert, Dialog, Modal, Snackbar

### Using Components in JSON

```json
{
  "type": "Button",
  "props": {
    "variant": "contained",
    "color": "primary",
    "children": "Click Me"
  },
  "on": {
    "click": "handleSubmit"
  }
}
```

### Component Prop Mapping

JSON props map directly to component props:

```json
{
  "type": "Input",
  "props": {
    "label": "Email",           // ‚Üí label="Email"
    "type": "email",            // ‚Üí type="email"
    "required": true,           // ‚Üí required={true}
    "fullWidth": true           // ‚Üí fullWidth={true}
  }
}
```

---

## üé® Adapter Resolution

PageRenderer automatically resolves adapters based on current provider:

```
JSON: { "type": "Button" }
    ‚Üì
Provider: MUI
    ‚Üì
Renders: MUI Button
```

**No code changes needed** when switching providers!

### Provider Differences Handled

| Component | MUI | ShadCN | Differences |
|-----------|-----|--------|-------------|
| Button | ‚úÖ | ‚úÖ | None |
| Input | ‚úÖ | ‚ö†Ô∏è | Label placement |
| Card | ‚úÖ | ‚ö†Ô∏è | Subheader support |

See [Adapter Warnings Story](?path=/docs/core-adapter-warnings) for details.

---

## ‚ö†Ô∏è Error Handling

### Validation Errors

Display inline with `ValidationErrorDisplay`:

```tsx
import { validatePageConfig } from '@sakhlaqi/ui/schema';
import { ValidationErrorDisplay } from '@sakhlaqi/ui/components';

const result = validatePageConfig(config);

if (!result.success) {
  return <ValidationErrorDisplay errors={result.errors} />;
}
```

### Render Errors

Caught by error boundary:

```tsx
<PageRenderer 
  config={config}
  errorComponent={({ error, errors }) => (
    <div>
      <h2>Render Error</h2>
      <p>{error.message}</p>
      <ul>
        {errors.map(err => (
          <li key={err.key}>{err.message}</li>
        ))}
      </ul>
    </div>
  )}
/>
```

### Adapter Warnings

Non-blocking fallback warnings:

```tsx
<PageRenderer 
  config={config}
  showInlineWarnings={true}
  onAdapterWarning={(warning) => {
    console.warn('Adapter fallback:', warning);
  }}
/>
```

See [Error Display Story](?path=/docs/core-error-warning-overlay) for examples.

---

## üöÄ Performance

### Optimization Tips

1. **Memoize Configs**
   ```tsx
   const config = useMemo(() => ({ template: 'DashboardLayout', ... }), []);
   ```

2. **Validate Once**
   ```tsx
   const validated = useMemo(() => validatePageConfig(config), [config]);
   ```

3. **Use Keys**
   ```json
   {
     "type": "Button",
     "key": "submit-btn",  // Helps React reconciliation
     "props": { ... }
   }
   ```

4. **Avoid Deep Nesting**
   - Keep component tree < 5 levels deep
   - Use templates for structure
   - Flatten when possible

### Performance Metrics

- Small page (5 components): ~10ms render
- Medium page (20 components): ~30ms render
- Large page (100 components): ~150ms render

*Measured on M1 MacBook Pro*

---

## ‚ö†Ô∏è Limitations

### Known Issues

1. **No Dynamic Imports**
   - All components must be registered at build time
   - Cannot load components dynamically from URLs

2. **Limited Event Handlers**
   - Only registered behaviors can be used
   - Cannot pass inline functions in JSON

3. **No React Hooks**
   - JSON configs are static
   - Cannot use useState, useEffect, etc.
   - Use behaviors for interactivity

4. **Type Safety at Runtime Only**
   - TypeScript types inferred from Zod schemas
   - No compile-time checking for JSON configs
   - Validation happens at runtime

5. **Performance Overhead**
   - Validation adds ~5-10ms overhead
   - Direct JSX is faster
   - Consider caching validated configs

---

## üîí Security

### XSS Protection

**Built-in:** React escapes all strings automatically.

**‚ö†Ô∏è Warning:** Never use `dangerouslySetInnerHTML` in JSON configs!

### Config Validation

Always validate configs from external sources:

```tsx
// ‚úÖ Good: Validate first
const result = validatePageConfig(externalConfig);
if (result.success) {
  return <PageRenderer config={result.data} />;
}

// ‚ùå Bad: Render unvalidated config
return <PageRenderer config={externalConfig} />;
```

### Trusted Sources Only

- Only load configs from trusted APIs
- Implement server-side validation
- Use HTTPS for config endpoints
- Consider signing configs

---

## üéØ Best Practices

### Do's ‚úÖ

- Validate all configs before rendering
- Use TypeScript for config objects
- Implement error boundaries
- Cache validated configs
- Use meaningful component keys
- Keep nesting shallow (< 5 levels)
- Test configs in Storybook first
- Document custom templates and behaviors

### Don'ts ‚ùå

- Don't render unvalidated external configs
- Don't nest more than 5 levels deep
- Don't use PageRenderer for static content
- Don't skip error handling
- Don't ignore validation errors
- Don't put business logic in JSON
- Don't use for SEO-critical pages

---

## üîó Related Documentation

- **[Getting Started](?path=/docs/getting-started)** - Quick start guide
- **[Templates](?path=/docs/templates-overview)** - Available templates
- **[Components](?path=/docs/components-button)** - Component reference
- **[Validation](?path=/docs/core-validation-display)** - Error handling
- **[Anti-Patterns](?path=/docs/anti-patterns-invalid-json-configs)** - What to avoid

---

## üîç Examples in Storybook

Explore live examples:

- **[Dashboard Page](?path=/story/pages-json-pages--dashboard-page)** - Complete dashboard
- **[Form Page](?path=/story/pages-json-pages--employee-form)** - Form layout
- **[List Detail](?path=/story/pages-json-pages--list-detail-page)** - Master-detail view
- **[Invalid Config](?path=/story/anti-patterns-invalid-json-configs--missing-required-fields)** - Error handling

---

## üêõ Troubleshooting

### Config Not Rendering

**Problem:** PageRenderer shows nothing.

**Solutions:**
- Check validation errors: `validatePageConfig(config)`
- Verify template exists in TemplateRegistry
- Ensure required slots are provided
- Check browser console for errors

### Components Not Showing

**Problem:** Some components don't render.

**Solutions:**
- Verify component type exists in ComponentRegistry
- Check for typos in component names (case-sensitive)
- Ensure props are valid for that component
- Look for adapter warnings

### Validation Fails

**Problem:** validatePageConfig returns errors.

**Solutions:**
- Read error messages carefully (include path)
- Check ComponentRegistry for valid component types
- Verify template exists in TemplateRegistry
- Ensure all required fields are present
- Validate JSON syntax if using string config

### Provider Switching Issues

**Problem:** Components look wrong after switching provider.

**Solutions:**
- Check for adapter warnings
- Some components may have different props
- Review [Adapter Behavior](?path=/docs/documentation-components-button--docs#adapter-behavior)
- Report persistent issues

---

**Last Updated:** January 2026  
**Component Version:** 3.3.0  
**Status:** ‚úÖ Stable
